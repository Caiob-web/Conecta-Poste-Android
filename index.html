<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mapa de Postes</title>

    <!-- PWA -->
    <meta name="theme-color" content="#0055a5" />
    <link rel="manifest" href="/manifest.json" />

    <!-- Favicon -->
    <link rel="icon" href="https://cdn.glitch.global/f333e829-c383-4385-9e81-43a47d865216/ChatGPT%20Image%2019%20de%20jun.%20de%202025%2C%2021_12_44.png?v=1750378383582" type="image/png" sizes="64x64" />

    <!-- Perf: pré-conexões -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>

    <!-- Leaflet & MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <style>
      html, body { margin: 0; padding: 0; height: 100%; }
      #map { width: 100%; height: 100%; }

      /* Painel lateral — layout compacto e normalizado */
      .painel-busca {
        position: absolute; top: 80px; right: 20px;
        width: 260px;
        background: #fff; border-left: 4px solid #0055a5; border-radius: 8px;
        padding: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        font-family: "Segoe UI", system-ui, Arial, sans-serif; z-index: 1000;
      }
      @media (min-width: 480px){ .painel-busca{ width: 300px; } }
      @media (min-width: 768px){ .painel-busca{ width: 320px; } }

      .painel-busca h3 { margin: 0 0 12px; color: #0055a5; font-size: 16px; }

      .painel-busca .field { margin-bottom: 10px; position: relative; }
      .painel-busca input {
        width: 100%;
        height: 36px;
        padding: 8px 36px 8px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
      }
      .painel-busca .field .fa {
        position: absolute; right: 10px; top: 50%;
        transform: translateY(-50%);
        color: #888; font-size: 14px; pointer-events: none;
      }

      .painel-busca .actions {
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
      }
      .painel-busca .actions button {
        height: 36px;
        background: #0055a5; color: #fff;
        border: none; border-radius: 6px;
        display: inline-flex; align-items: center; justify-content: center;
        gap: 6px; font-weight: 600; cursor: pointer;
      }
      .painel-busca .actions button:hover { background: #003f7d; }

      /* Legenda */
      .legenda {
        position: absolute; bottom: 20px; right: 20px;
        background: rgba(255,255,255,0.9); padding: 12px; border-radius: 6px;
        font-size: 13px; font-family: "Segoe UI", system-ui, Arial, sans-serif;
        z-index: 1050;
      }
      .legenda-item { display: flex; align-items: center; margin-bottom: 6px; }
      .legenda-item .bolinha {
        width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; border: 1px solid #888;
      }

      /* Botões flutuantes — agora FIXOS para garantir o clique */
      .botao-topo {
        position: fixed; right: 20px; width: 48px; height: 48px;
        background: #fff; border: 1px solid #ccc; border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0,0,0,.18);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; z-index: 3000; pointer-events: auto;
      }
      .botao-topo i { color: #333; font-size: 18px; }
      .botao-topo:active { transform: scale(0.98); }
      #togglePainel { top: 20px; }
      #localizacaoUsuario { top: 78px; }

      /* Widget clima */
      #widget-clima {
        position: absolute; bottom: 20px; left: 20px;
        background: rgba(255,255,255,0.95); border-radius: 6px;
        padding: 12px; font-size: 14px; font-family: "Segoe UI", system-ui, Arial, sans-serif;
        width: 220px; z-index: 1100;
      }
      #widget-clima #hora { font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; }
      #widget-clima #tempo { display: flex; align-items: center; }
      #widget-clima img { width: 32px; height: 32px; margin-right: 8px; }

      /* Overlay */
      .overlay-loading {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.8);
        display: none; align-items: center; justify-content: center; flex-direction: column;
        z-index: 4000;
      }
      .spinner { border: 6px solid #ccc; border-top: 6px solid #0055a5; border-radius: 50%; width: 48px; height: 48px; animation: girar 1s linear infinite; }
      .texto-loading { margin-top: 12px; color: #0055a5; font-family: "Segoe UI", system-ui, Arial, sans-serif; }
      @keyframes girar { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

      /* util */
      .hidden { display: none !important; }
    </style>
  </head>
  <body>
    <!-- Botões flutuantes (funcionais) -->
    <button id="togglePainel" class="botao-topo" aria-label="Mostrar/ocultar painel">
      <i class="fa fa-sliders"></i>
    </button>
    <button id="localizacaoUsuario" class="botao-topo" aria-label="Minha localização">
      <i class="fa fa-location-dot"></i>
    </button>

    <!-- Painel -->
    <div class="painel-busca" id="painelBusca">
      <h3>Buscar Postes</h3>

      <div class="field">
        <input type="text" id="busca-id" placeholder="ID do Poste…"/>
        <i class="fa fa-hashtag"></i>
      </div>

      <div class="field">
        <input type="text" id="busca-coord" placeholder="Lat, Lon…"/>
        <i class="fa fa-map-marker-alt"></i>
      </div>

      <div class="field">
        <input type="text" id="busca-municipio" placeholder="Município…" list="lista-municipios"/>
        <i class="fa fa-city"></i>
      </div>
      <datalist id="lista-municipios"></datalist>

      <div class="field">
        <input type="text" id="busca-empresa" placeholder="Empresa…" list="lista-empresas"/>
        <i class="fa fa-building"></i>
      </div>
      <datalist id="lista-empresas"></datalist>

      <div class="actions">
        <button onclick="buscarID()"><i class="fa fa-search"></i>Buscar</button>
        <button onclick="buscarCoordenada()"><i class="fa fa-location-dot"></i>Coord</button>
        <button onclick="filtrarLocal()"><i class="fa fa-filter"></i>Filtrar</button>
        <button onclick="resetarMapa()"><i class="fa fa-undo"></i>Reset</button>
        <button id="btnCenso"><i class="fa fa-camera"></i>Censo</button>
      </div>
    </div>

    <!-- Legenda -->
    <div class="legenda">
      <div class="legenda-item"><div class="bolinha" style="background: green"></div>0–3 empresas</div>
      <div class="legenda-item"><div class="bolinha" style="background: yellow"></div>4–5 empresas</div>
      <div class="legenda-item"><div class="bolinha" style="background: red"></div>6+ empresas</div>
    </div>

    <!-- Mapa -->
    <div id="map"></div>

    <!-- Clima -->
    <div id="widget-clima">
      <div id="hora"><i class="fa fa-clock"></i><span>--:--</span></div>
      <div id="tempo"><img src="" alt="" /><span>Carregando...</span></div>
    </div>

    <!-- Overlay -->
    <div id="carregando" class="overlay-loading">
      <div class="spinner"></div>
      <div class="texto-loading">Carregando postes…</div>
    </div>

    <!-- Scripts -->
    <script defer src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script defer src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script defer src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script defer src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
    <script defer src="/script.js"></script>

    <!-- Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js', { scope: '/' }).catch(console.error);
        });
      }
    </script>
  </body>
</html>
